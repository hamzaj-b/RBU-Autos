// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserType {
  ADMIN
  CUSTOMER
  EMPLOYEE
}

enum BookingStatus {
  PENDING
  ACCEPTED
  CANCELLED
  DONE
}

enum BookingType {
  WALKIN
  PREBOOKING
}

enum WorkOrderStatus {
  DRAFT // Admin prepared, not visible to employees yet
  OPEN // Visible to all employees, unassigned
  ASSIGNED // Directly assigned to an employee by Admin
  WAITING // Waiting for employee to start work
  IN_PROGRESS // Employee started work
  DONE // Employee marked work as done (pending admin review)
  COMPLETED // Admin reviewed and finalized the work order
  CANCELLED // Job cancelled (admin/employee)
}

model User {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  email             String   @unique
  phone             String?  @unique
  passwordEncrypted String?
  userType          UserType @default(ADMIN)
  isActive          Boolean  @default(true)

  // Profiles
  employee EmployeeProfile? @relation(fields: [employeeProfileId], references: [id])
  customer CustomerProfile? @relation(fields: [customerProfileId], references: [id])

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  employeeProfileId String?        @db.ObjectId
  customerProfileId String?        @db.ObjectId
  Notification      Notification[]

  @@index([userType, isActive])
}

model EmployeeProfile {
  id         String            @id @default(auto()) @map("_id") @db.ObjectId
  userId     String            @unique @db.ObjectId
  fullName   String
  title      String?
  hourlyRate Float?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  User       User[]
  WorkOrder  WorkOrder[]
  Sessions   EmployeeSession[] @relation("ProfileSessions") // âœ… added relation name

  @@index([fullName])
}

model CustomerProfile {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  userId      String      @unique @db.ObjectId
  fullName    String
  vehicleJson Json?
  addressJson Json?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  User        User[]
  Booking     Booking[]
  WorkOrder   WorkOrder[]

  @@index([fullName])
}

model Service {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  category        String?
  description     String?
  durationMinutes Int?
  basePrice       Float?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // relations
  bookingServices   BookingService[]
  workOrderServices WorkOrderService[]

  @@index([name, isActive])
  @@index([category])
}

model Booking {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String        @db.ObjectId
  createdByUserId String        @db.ObjectId
  status          BookingStatus @default(PENDING)

  // ðŸ†• Booking Type
  bookingType BookingType @default(WALKIN)

  // scheduling
  date        DateTime
  startAt     DateTime
  endAt       DateTime
  slotMinutes Int

  // timestamps
  acceptedAt  DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // meta
  notes       String?
  attachments Json?

  // relations
  customer        CustomerProfile  @relation(fields: [customerId], references: [id])
  workOrder       WorkOrder?       @relation("BookingToWorkOrder")
  bookingServices BookingService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, date])
  @@index([customerId, date])
  @@index([startAt, endAt])
}

model WorkOrder {
  id         String          @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String          @unique @db.ObjectId
  customerId String          @db.ObjectId
  employeeId String?         @db.ObjectId
  status     WorkOrderStatus @default(DRAFT)

  laborEntries Json?
  partsUsed    Json?
  photos       Json?
  notes        String?
  openedAt     DateTime?
  closedAt     DateTime?

  totalRevenue Float? @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  booking           Booking            @relation("BookingToWorkOrder", fields: [bookingId], references: [id])
  customer          CustomerProfile    @relation(fields: [customerId], references: [id])
  employee          EmployeeProfile?   @relation(fields: [employeeId], references: [id])
  workOrderServices WorkOrderService[]

  @@index([employeeId, status])
  @@index([status, createdAt])
  @@index([customerId])
}

//
// ðŸ”— Explicit Join Models (Required for MongoDB)
//

model BookingService {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  bookingId String  @db.ObjectId
  serviceId String  @db.ObjectId
  booking   Booking @relation(fields: [bookingId], references: [id])
  service   Service @relation(fields: [serviceId], references: [id])

  @@index([bookingId])
  @@index([serviceId])
}

model WorkOrderService {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  workOrderId String    @db.ObjectId
  serviceId   String    @db.ObjectId
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
  service     Service   @relation(fields: [serviceId], references: [id])

  @@index([workOrderId])
  @@index([serviceId])
}

model EmployeeSession {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  userId     String    @db.ObjectId
  employeeId String?   @db.ObjectId
  loginAt    DateTime
  logoutAt   DateTime?
  source     String?
  location   String?
  latitude   Float?    @db.Double
  longitude  Float?    @db.Double
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // âœ… Proper relation link
  employee EmployeeProfile? @relation("ProfileSessions", fields: [employeeId], references: [id])

  @@index([userId, loginAt])
  @@index([logoutAt])
}
model BusinessSettings {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  timezone             String
  utc                  String   @default("(UTC+00:00)") // âœ… new field
  openTime             String
  closeTime            String
  slotMinutes          Int
  bufferMinutes        Int      @default(0)
  allowCustomerBooking Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Notification {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title     String
  message   String
  type      String? // e.g. "BOOKING_APPROVED", "BOOKING_REJECTED"
  isRead    Boolean   @default(false)
  metadata  Json?
  createdAt DateTime  @default(now())
  readAt    DateTime?
}
